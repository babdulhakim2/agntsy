<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Agentsy</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ========== RESET & BASE ========== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: #F5F0EB;
  color: #1A1A1A;
  line-height: 1.5;
  touch-action: manipulation;
}

:root {
  --cream: #F5F0EB;
  --charcoal: #2D2A26;
  --sage: #A3B18A;
  --gold: #C9A96E;
  --gold-light: #e8d5b0;
  --white: #FAFAF8;
  --dark: #1A1A1A;
  --stone: #E8E0D8;
  --stone-light: #efe8e0;
  --muted: #7A746D;
  --muted-light: #9E9891;
  --border: rgba(0,0,0,0.08);
  --radius: 16px;
  --radius-sm: 10px;
  --ease: cubic-bezier(0.22, 1, 0.36, 1);
  --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

button { font-family: inherit; cursor: pointer; border: none; background: none; color: inherit; outline: none; -webkit-tap-highlight-color: transparent; }
input, textarea { font-family: inherit; border: none; outline: none; -webkit-tap-highlight-color: transparent; }
a { color: var(--gold); text-decoration: none; }

/* ========== APP SHELL ========== */
.app {
  width: 100%;
  height: 100dvh;
  max-width: 600px;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
  background: var(--white);
  box-shadow: 0 0 80px rgba(0,0,0,0.08);
}

/* ========== VIEW CONTAINER â€” GPU composited ========== */
.views {
  display: flex;
  width: 200%;
  height: 100%;
  will-change: transform;
  transform: translate3d(0, 0, 0);
  transition: transform 0.42s var(--ease-out);
}
.views.show-chat { transform: translate3d(-50%, 0, 0); }

.view {
  width: 50%;
  height: 100%;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  backface-visibility: hidden;
  transform: translate3d(0, 0, 0);
}

/* Threads view transition effect â€” subtle scale+fade when sliding away */
#threadsView {
  transition: opacity 0.42s var(--ease-out);
}
.views.show-chat #threadsView {
  opacity: 0.6;
}

/* ========== THREADS VIEW ========== */
.threads-header {
  padding: 20px 24px 16px;
  padding-top: calc(20px + var(--safe-top));
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.logo {
  font-family: 'Instrument Serif', Georgia, serif;
  font-size: 1.65rem;
  font-weight: 400;
  color: var(--dark);
  letter-spacing: -0.02em;
}
.logo-dot { color: var(--gold); }
.new-thread-btn {
  width: 38px;
  height: 38px;
  border-radius: var(--radius-sm);
  background: var(--charcoal);
  color: var(--white);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 300;
  transition: transform 0.15s var(--ease), background 0.15s;
}
.new-thread-btn:hover { background: var(--dark); transform: scale(1.05); }
.new-thread-btn:active { transform: scale(0.92); background: #1a1715; }

.threads-search {
  padding: 0 24px 14px;
  flex-shrink: 0;
}
.search-box {
  width: 100%;
  padding: 11px 16px;
  border-radius: var(--radius-sm);
  background: var(--cream);
  border: 1px solid transparent;
  font-size: 14px;
  color: var(--dark);
  transition: all 0.2s;
}
.search-box::placeholder { color: var(--muted-light); }
.search-box:focus { border-color: var(--stone); background: var(--white); }

.threads-list {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
.threads-list::-webkit-scrollbar { display: none; }

.thread-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 24px;
  cursor: pointer;
  transition: background 0.1s, transform 0.1s;
  position: relative;
  content-visibility: auto;
  contain-intrinsic-size: auto 80px;
}
.thread-item:hover { background: rgba(0,0,0,0.025); }
.thread-item:active { background: rgba(0,0,0,0.05); transform: scale(0.985); }
.thread-item + .thread-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 72px;
  right: 24px;
  height: 1px;
  background: var(--border);
}

.thread-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Instrument Serif', serif;
  font-size: 18px;
  color: var(--white);
}
.thread-avatar.gold { background: var(--gold); }
.thread-avatar.sage { background: var(--sage); }
.thread-avatar.charcoal { background: var(--charcoal); }
.thread-avatar.stone { background: #B5AFA8; }

.thread-body {
  flex: 1;
  min-width: 0;
}
.thread-top {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 3px;
}
.thread-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--dark);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.thread-time {
  font-size: 12px;
  color: var(--muted-light);
  flex-shrink: 0;
}
.thread-preview {
  font-size: 13.5px;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
}
.thread-unread .thread-title { color: var(--dark); }
.thread-unread .thread-time { color: var(--gold); font-weight: 600; }
.thread-badge {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--gold);
  flex-shrink: 0;
}

/* ========== CHAT VIEW ========== */
.chat-header {
  padding: 14px 16px 14px 8px;
  padding-top: calc(14px + var(--safe-top));
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
  border-bottom: 1px solid var(--border);
  background: var(--white);
}
.back-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.1s, transform 0.1s;
  flex-shrink: 0;
}
.back-btn:hover { background: var(--cream); }
.back-btn:active { background: var(--stone); transform: scale(0.9); }
.back-btn svg { width: 22px; height: 22px; color: var(--charcoal); }
.chat-header-avatar {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  background: var(--gold);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Instrument Serif', serif;
  font-size: 14px;
  color: var(--white);
  flex-shrink: 0;
}
.chat-header-info { flex: 1; min-width: 0; }
.chat-header-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--dark);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.chat-header-status {
  font-size: 12px;
  color: var(--sage);
  display: flex;
  align-items: center;
  gap: 5px;
}
.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--sage);
}

/* ========== MESSAGES ========== */
.messages {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  padding: 20px 16px;
  display: flex;
  flex-direction: column;
  scroll-behavior: auto; /* JS handles smooth scroll via rAF */
}
.messages::-webkit-scrollbar { width: 3px; }
.messages::-webkit-scrollbar-thumb { background: var(--stone); border-radius: 3px; }

/* Message spacing: tighter for same sender, wider for new sender */
.msg + .msg { margin-top: 4px; }
.msg + .msg.new-sender { margin-top: 14px; }

.msg {
  display: flex;
  gap: 8px;
  max-width: 88%;
  opacity: 1;
  transform: translate3d(0, 0, 0);
}
.msg.stagger-in {
  animation: msgIn 0.3s var(--ease) both;
}
.msg.user { margin-left: auto; flex-direction: row-reverse; }

.msg-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--gold);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Instrument Serif', serif;
  font-size: 12px;
  color: var(--white);
  margin-top: 2px;
}
.msg.user .msg-avatar { display: none; }

/* Hide avatar on sequential agent messages, use spacer */
.msg-avatar-spacer {
  width: 28px;
  flex-shrink: 0;
}

.msg-body { min-width: 0; max-width: 100%; overflow: hidden; }

.msg-bubble {
  padding: 12px 16px;
  font-size: 14.5px;
  line-height: 1.6;
  word-wrap: break-word;
}
.msg.agent .msg-bubble {
  background: #F4F1ED;
  color: var(--dark);
  border-radius: 4px var(--radius) var(--radius) var(--radius);
  border: 1px solid rgba(0,0,0,0.06);
}
.msg.user .msg-bubble {
  background: var(--charcoal);
  color: #FFFFFF;
  border-radius: var(--radius) 4px var(--radius) var(--radius);
}

/* Timestamp â€” only shown on last message in a group by default */
.msg-time {
  font-size: 11px;
  color: var(--muted-light);
  margin-top: 4px;
  padding: 0 4px;
  display: none; /* hidden by default */
}
.msg-time.show { display: block; }
.msg.user .msg-time { text-align: right; }

/* Agent name label */
.msg-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--gold);
  margin-bottom: 4px;
  padding-left: 4px;
  letter-spacing: 0.02em;
}

/* Streaming cursor */
.streaming-cursor {
  display: inline;
  animation: blink 1s step-end infinite;
  color: var(--gold);
  font-weight: 300;
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

/* ========== RICH CONTENT ========== */
.attachment {
  margin-top: 8px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
  background: var(--white);
  max-width: 100%;
}
.attachment:hover {
  border-color: var(--stone);
  box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  transform: translateY(-1px);
}
.attachment:active { transform: scale(0.98); }
.attach-doc {
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.attach-icon {
  width: 42px;
  height: 42px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}
.attach-icon.doc { background: rgba(108,99,255,0.1); }
.attach-icon.sheet { background: rgba(163,177,138,0.2); }
.attach-icon.pdf { background: rgba(201,169,110,0.2); }
.attach-icon.link { background: rgba(45,42,38,0.08); }
.attach-info { flex: 1; min-width: 0; }
.attach-name {
  font-size: 13.5px;
  font-weight: 600;
  color: var(--dark);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.attach-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
.attach-action { font-size: 12px; color: var(--gold); font-weight: 600; flex-shrink: 0; }

.link-preview {
  margin-top: 8px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
  background: var(--white);
  max-width: 100%;
}
.link-preview:hover { border-color: var(--stone); box-shadow: 0 4px 16px rgba(0,0,0,0.06); }
.link-preview:active { transform: scale(0.98); }
.link-preview-img { height: 130px; background-size: cover; background-position: center; }
.link-preview-body { padding: 12px 14px; }
.link-preview-domain { font-size: 11px; color: var(--gold); font-weight: 500; margin-bottom: 3px; }
.link-preview-title { font-size: 13.5px; font-weight: 600; color: var(--dark); line-height: 1.4; }
.link-preview-desc { font-size: 12.5px; color: var(--muted); margin-top: 3px; line-height: 1.4; }

.code-block {
  margin-top: 8px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  border: 1px solid var(--border);
}
.code-header {
  padding: 8px 14px;
  background: var(--cream);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  color: var(--muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.code-body {
  padding: 14px;
  background: var(--white);
  font-family: 'SF Mono', Monaco, Consolas, monospace;
  font-size: 13px;
  line-height: 1.6;
  overflow-x: auto;
  color: var(--charcoal);
}

.data-table {
  margin-top: 8px;
  border-radius: var(--radius-sm);
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  border: 1px solid var(--border);
  width: 100%;
  max-width: 100%;
  background: var(--white);
}
.data-table table { min-width: 320px; width: 100%; border-collapse: collapse; font-size: 12.5px; }
.data-table th {
  padding: 10px 14px;
  background: var(--cream);
  text-align: left;
  font-weight: 600;
  color: var(--muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.data-table td { padding: 10px 14px; border-top: 1px solid var(--border); color: var(--dark); }
.data-table tr:hover td { background: rgba(0,0,0,0.015); }

.typing { display: flex; gap: 5px; padding: 12px 16px; }
.typing span {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--stone);
  animation: typingBounce 1.2s infinite;
}
.typing span:nth-child(2) { animation-delay: 0.15s; }
.typing span:nth-child(3) { animation-delay: 0.3s; }

/* ========== COMPOSER ========== */
.composer {
  padding: 12px 16px;
  padding-bottom: calc(12px + var(--safe-bottom));
  flex-shrink: 0;
  background: var(--white);
  border-top: 1px solid var(--border);
}
.composer-inner {
  display: flex;
  align-items: flex-end;
  gap: 10px;
  background: var(--cream);
  border-radius: 22px;
  padding: 8px 8px 8px 18px;
  transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
  border: 1.5px solid transparent;
}
.composer-inner:focus-within {
  border-color: var(--stone);
  background: var(--white);
  box-shadow: 0 2px 12px rgba(0,0,0,0.04);
}
.composer-input {
  flex: 1;
  background: none;
  font-size: 14.5px;
  color: var(--dark);
  resize: none;
  max-height: 120px;
  line-height: 1.5;
  padding: 4px 0;
}
.composer-input::placeholder { color: var(--muted-light); }
.send-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--charcoal);
  color: var(--white);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: transform 0.12s var(--ease), background 0.15s;
}
.send-btn:hover { background: var(--dark); transform: scale(1.06); }
.send-btn:active { transform: scale(0.88); }
.send-btn.pop {
  animation: sendPop 0.3s var(--ease);
}
@keyframes sendPop {
  0% { transform: scale(1); }
  40% { transform: scale(0.82); }
  100% { transform: scale(1); }
}
.send-btn svg { width: 18px; height: 18px; }

/* ========== PREVIEW OVERLAY ========== */
.preview-overlay {
  position: fixed;
  inset: 0;
  background: rgba(45,42,38,0.5);
  z-index: 200;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  opacity: 0;
  transition: opacity 0.25s ease;
}
.preview-overlay.show { display: flex; opacity: 1; }
.preview-card {
  background: var(--white);
  border-radius: var(--radius);
  max-width: 560px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 24px 80px rgba(0,0,0,0.15);
  transform: translate3d(0, 20px, 0) scale(0.97);
  transition: transform 0.3s var(--ease-out);
}
.preview-overlay.show .preview-card {
  transform: translate3d(0, 0, 0) scale(1);
}
.preview-header {
  padding: 18px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--white);
  z-index: 1;
  border-radius: var(--radius) var(--radius) 0 0;
}
.preview-title {
  font-family: 'Instrument Serif', serif;
  font-size: 17px;
  color: var(--dark);
}
.preview-close {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: var(--muted);
  transition: all 0.1s;
}
.preview-close:hover { background: var(--cream); color: var(--dark); }
.preview-close:active { transform: scale(0.9); background: var(--stone); }
.preview-body { padding: 24px; }

/* ========== EMPTY CHAT STATE ========== */
.empty-chat {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 40px;
  text-align: center;
  animation: emptyIn 0.5s var(--ease-out) both;
}
@keyframes emptyIn {
  from { opacity: 0; transform: translate3d(0, 16px, 0) scale(0.97); }
  to { opacity: 1; transform: translate3d(0, 0, 0) scale(1); }
}
.empty-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--cream);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Instrument Serif', serif;
  font-size: 24px;
  color: var(--gold);
  margin-bottom: 4px;
}
.empty-title {
  font-family: 'Instrument Serif', serif;
  font-size: 22px;
  color: var(--dark);
}
.empty-subtitle {
  font-size: 14px;
  color: var(--muted);
  max-width: 260px;
  line-height: 1.5;
}

/* Suggestion chips */
.suggestion-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 8px;
  animation: emptyIn 0.5s var(--ease-out) 0.15s both;
}
.suggestion-chip {
  padding: 8px 16px;
  border-radius: 20px;
  background: var(--cream);
  border: 1px solid var(--border);
  font-size: 13px;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.suggestion-chip:hover { background: var(--stone-light); color: var(--dark); border-color: var(--stone); }
.suggestion-chip:active { transform: scale(0.95); background: var(--stone); }

/* ========== ANIMATIONS ========== */
@keyframes msgIn {
  from { opacity: 0; transform: translate3d(0, 12px, 0); }
  to { opacity: 1; transform: translate3d(0, 0, 0); }
}
@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-5px); }
}

/* ========== DESKTOP ========== */
@media (min-width: 640px) {
  body { display: flex; align-items: center; justify-content: center; background: var(--cream); }
  .app {
    height: min(100dvh, 900px);
    border-radius: 24px;
    border: 1px solid var(--border);
    overflow: hidden;
    margin: 16px;
  }
}

/* ========== QUOTE BLOCKS ========== */
.quote-block {
  border-left: 3px solid var(--gold);
  padding: 8px 14px;
  margin: 8px 0;
  color: var(--muted);
  font-style: italic;
  background: rgba(201,169,110,0.06);
  border-radius: 0 6px 6px 0;
}
</style>
</head>
<body>

<div class="app">
  <div class="views" id="views">
    <!-- View 1: Threads List -->
    <div class="view" id="threadsView">
      <div class="threads-header">
        <div class="logo">Agentsy<span class="logo-dot">.</span></div>
        <button class="new-thread-btn" onclick="newThread()" aria-label="New thread">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="10" y1="4" x2="10" y2="16"/><line x1="4" y1="10" x2="16" y2="10"/></svg>
        </button>
      </div>
      <div class="threads-search">
        <input class="search-box" type="text" placeholder="Search conversationsâ€¦" oninput="filterThreads(this.value)">
      </div>
      <div class="threads-list" id="threadsList"></div>
    </div>

    <!-- View 2: Chat -->
    <div class="view" id="chatView">
      <div class="chat-header">
        <button class="back-btn" onclick="showThreads()" aria-label="Back">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div class="chat-header-avatar">A</div>
        <div class="chat-header-info">
          <div class="chat-header-title" id="chatTitle">Thread</div>
          <div class="chat-header-status"><span class="status-dot"></span>Online</div>
        </div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="composer">
        <div class="composer-inner">
          <textarea class="composer-input" id="input" rows="1" placeholder="Message Agentsyâ€¦" onkeydown="handleKey(event)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMsg()" aria-label="Send">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview overlay -->
<div class="preview-overlay" id="previewOverlay" onclick="if(event.target===this)closePreview()">
  <div class="preview-card">
    <div class="preview-header">
      <div class="preview-title" id="previewTitle">Document</div>
      <button class="preview-close" onclick="closePreview()">âœ•</button>
    </div>
    <div class="preview-body" id="previewBody"></div>
  </div>
</div>

<script>
// â”€â”€â”€ Preview Store (avoids broken inline onclick with HTML content) â”€â”€â”€
var _previewStore = {};

// â”€â”€â”€ Thread Data â”€â”€â”€
const THREADS = [
  {
    id: 1,
    title: "Market Research: SF Event Tech",
    avatarColor: "gold",
    avatarLetter: "M",
    time: "2m ago",
    unread: true,
    messages: [
      {
        role: "user",
        text: "Research the SF event tech market. Who are the main players and what gaps exist for small event organizers?",
        time: "11:02 AM"
      },
      {
        role: "agent",
        text: "I researched the SF event tech landscape. Here's what I found across 3 tiers of competition:",
        time: "11:03 AM",
        attachments: [{
          type: "pdf", icon: "ðŸ“Š",
          name: "SF Event Tech â€” Competitive Landscape.pdf",
          meta: "PDF Â· 12 pages Â· Generated just now",
          preview: {
            title: "SF Event Tech â€” Competitive Landscape",
            content: `<div style="line-height:1.8;color:#7A746D">
              <h3 style="color:#1A1A1A;margin-bottom:12px;font-size:16px;font-family:'Instrument Serif',serif;font-weight:400">Executive Summary</h3>
              <p>The SF event tech market is dominated by enterprise players (Bizzabo, Swapcard, Grip) serving 1000+ attendee conferences at $10K+/yr. The 50â€“200 person event segment â€” meetups, dinners, networking â€” is underserved.</p>
              <h3 style="color:#1A1A1A;margin:20px 0 12px;font-size:16px;font-family:'Instrument Serif',serif;font-weight:400">Key Players</h3>
              <table style="width:100%;border-collapse:collapse;font-size:13px;margin:10px 0">
                <tr style="border-bottom:1px solid rgba(0,0,0,0.07)"><td style="padding:8px 0;font-weight:600;color:#1A1A1A">Bizzabo</td><td style="padding:8px 0;color:#7A746D">$230M raised Â· Enterprise event OS</td></tr>
                <tr style="border-bottom:1px solid rgba(0,0,0,0.07)"><td style="padding:8px 0;font-weight:600;color:#1A1A1A">Luma</td><td style="padding:8px 0;color:#7A746D">Event creation Â· No post-event intelligence</td></tr>
                <tr style="border-bottom:1px solid rgba(0,0,0,0.07)"><td style="padding:8px 0;font-weight:600;color:#1A1A1A">Swapcard</td><td style="padding:8px 0;color:#7A746D">Trade show engagement Â· AI networking</td></tr>
                <tr><td style="padding:8px 0;font-weight:600;color:#1A1A1A">Grip</td><td style="padding:8px 0;color:#7A746D">$17M raised Â· AI matchmaking</td></tr>
              </table>
              <h3 style="color:#1A1A1A;margin:20px 0 12px;font-size:16px;font-family:'Instrument Serif',serif;font-weight:400">The Gap</h3>
              <p>Nobody owns the <strong style="color:#C9A96E">post-event relationship intelligence</strong> layer for small/mid events. Luma handles RSVPs but drops off after the event ends. This is the opportunity.</p>
            </div>`
          }
        }]
      },
      {
        role: "agent",
        text: "The biggest gap: **nobody helps small event organizers understand their community after the event.** Luma stops at RSVPs. Here's the market size breakdown:",
        time: "11:03 AM",
        attachments: [{
          type: "sheet", icon: "ðŸ“ˆ",
          name: "TAM Analysis â€” Event Intelligence.xlsx",
          meta: "Spreadsheet Â· 3 sheets",
          preview: {
            title: "TAM Analysis â€” Event Intelligence",
            content: `<div>
              <table style="width:100%;border-collapse:collapse;font-size:13px">
                <thead><tr style="border-bottom:2px solid rgba(0,0,0,0.1)">
                  <th style="padding:10px 0;text-align:left;color:#7A746D;font-size:11px;text-transform:uppercase;letter-spacing:0.5px">Segment</th>
                  <th style="padding:10px 0;text-align:right;color:#7A746D;font-size:11px;text-transform:uppercase">Organizers</th>
                  <th style="padding:10px 0;text-align:right;color:#7A746D;font-size:11px;text-transform:uppercase">ARPU</th>
                  <th style="padding:10px 0;text-align:right;color:#7A746D;font-size:11px;text-transform:uppercase">TAM</th>
                </tr></thead>
                <tbody>
                  <tr style="border-bottom:1px solid rgba(0,0,0,0.07)"><td style="padding:10px 0;color:#1A1A1A">Tech Meetups</td><td style="padding:10px 0;text-align:right;color:#1A1A1A">~15,000</td><td style="padding:10px 0;text-align:right;color:#1A1A1A">$150/mo</td><td style="padding:10px 0;text-align:right;color:#A3B18A;font-weight:600">$27M</td></tr>
                  <tr style="border-bottom:1px solid rgba(0,0,0,0.07)"><td style="padding:10px 0;color:#1A1A1A">VC/PE Events</td><td style="padding:10px 0;text-align:right;color:#1A1A1A">~3,000</td><td style="padding:10px 0;text-align:right;color:#1A1A1A">$500/mo</td><td style="padding:10px 0;text-align:right;color:#A3B18A;font-weight:600">$18M</td></tr>
                  <tr style="border-bottom:1px solid rgba(0,0,0,0.07)"><td style="padding:10px 0;color:#1A1A1A">Community Orgs</td><td style="padding:10px 0;text-align:right;color:#1A1A1A">~50,000</td><td style="padding:10px 0;text-align:right;color:#1A1A1A">$75/mo</td><td style="padding:10px 0;text-align:right;color:#A3B18A;font-weight:600">$45M</td></tr>
                  <tr><td style="padding:10px 0;font-weight:700;color:#1A1A1A">Total</td><td></td><td></td><td style="padding:10px 0;text-align:right;color:#C9A96E;font-weight:700;font-size:15px">$90M</td></tr>
                </tbody>
              </table>
            </div>`
          }
        }]
      },
      {
        role: "user",
        text: "Perfect. Now find me 10 SF event organizers on Luma who run recurring events with 100+ attendees",
        time: "11:05 AM"
      },
      {
        role: "agent",
        text: "Found 10 active SF organizers on Luma with recurring high-attendance events. Here's the top 6 with their event frequency and estimated audience:",
        time: "11:06 AM",
        attachments: [{
          type: "link", icon: "ðŸ”—",
          name: "lu.ma/sf",
          domain: "luma.com",
          linkPreview: {
            img: "linear-gradient(135deg, #E8E0D8, #C9A96E)",
            domain: "luma.com",
            title: "Popular Events in San Francisco",
            desc: "Discover the hottest events in San Francisco â€” tech talks, creative meetups, and more."
          }
        }],
        table: {
          headers: ["Organizer", "Type", "Frequency", "Avg Size"],
          rows: [
            ["Deep Tech Connections", "Networking", "Weekly", "80â€“120"],
            ["SF Hardware Meetup", "Industry", "Monthly", "150â€“200"],
            ["Venn Social Club", "Social", "Bi-weekly", "200â€“400"],
            ["AI Philosophy Nights", "Discussion", "Monthly", "100â€“150"],
            ["Founders Inc.", "Hackathons", "Monthly", "300â€“600"],
            ["Known", "Social", "Bi-weekly", "150â€“300"]
          ]
        }
      }
    ]
  },
  {
    id: 2,
    title: "Investor Outreach Draft",
    avatarColor: "charcoal",
    avatarLetter: "I",
    time: "1h ago",
    unread: false,
    messages: [
      {
        role: "user",
        text: "Draft a cold email to a VC partner about Kith. Keep it short, reference their portfolio.",
        time: "10:15 AM"
      },
      {
        role: "agent",
        text: "Here's a personalized cold email template. I've kept it to 4 sentences â€” VCs skim fast:\n\n**Subject:** Community intelligence for your portfolio's events\n\nHi [Name],\n\nI noticed [Fund] hosts regular founder dinners and LP events. After the event ends, how does your team track which connections were made and who needs follow-up?\n\nWe're building Kith â€” an AI layer that turns event attendee lists into relationship intelligence. Think of it as the back-office tool Luma doesn't have.\n\nWorth a 10-min call? Happy to demo with your actual event data.\n\nâ€” Hakim",
        time: "10:16 AM"
      }
    ]
  },
  {
    id: 3,
    title: "Landing Page Copy",
    avatarColor: "sage",
    avatarLetter: "L",
    time: "3h ago",
    unread: false,
    messages: [
      {
        role: "user",
        text: "Write hero copy for Kith's landing page targeting event organizers",
        time: "8:30 AM"
      },
      {
        role: "agent",
        text: "Three options, each with a different angle:\n\n**Option A â€” The Gap**\n> Your event ends. Then what?\n> Kith turns attendee lists into relationship intelligence â€” so your community keeps growing between events.\n\n**Option B â€” The Problem**\n> You know who RSVPed. But do you know who connected?\n> AI-powered community intelligence for event organizers.\n\n**Option C â€” The Bold**\n> Luma handles the invite. Kith handles everything after.\n> Relationship intelligence for the people who bring people together.",
        time: "8:31 AM"
      }
    ]
  },
  {
    id: 4,
    title: "YC Application Review",
    avatarColor: "stone",
    avatarLetter: "Y",
    time: "Yesterday",
    unread: false,
    messages: [
      {
        role: "user",
        text: "Review my YC application draft. Be brutally honest about what's weak.",
        time: "Yesterday"
      },
      {
        role: "agent",
        text: "Reviewed it. Overall it's solid, but three things need work:\n\n**1. The problem statement is too generic.** \"Events lack follow-up tools\" â€” every CRM says this. Lead with a specific pain: *\"After hosting 200-person dinners, I had zero idea who actually talked to whom.\"*\n\n**2. Your traction numbers are buried.** Move the 47 pilot organizers and 12K events processed to the FIRST line. YC partners scan hundreds of these.\n\n**3. The \"Why now?\" is weak.** Tie it to the post-COVID event boom. In-person events are back at 2x the pre-COVID pace, but the tooling hasn't caught up.",
        time: "Yesterday"
      }
    ]
  },
  {
    id: 5,
    title: "Weekly Planning",
    avatarColor: "gold",
    avatarLetter: "W",
    time: "2 days ago",
    unread: false,
    messages: [
      {
        role: "user",
        text: "Help me plan this week. Top priorities: finish MVP, prep investor deck, schedule 5 user interviews.",
        time: "2 days ago"
      },
      {
        role: "agent",
        text: "Here's a structured plan. I've blocked time assuming ~10 productive hours/day:\n\n**Monday â€” MVP Sprint**\nâ€¢ Finalize event import flow (3h)\nâ€¢ Build relationship graph view (4h)\nâ€¢ Write onboarding sequence (2h)\n\n**Tuesday â€” MVP + Users**\nâ€¢ QA and bug fixes (3h)\nâ€¢ Send 15 outreach emails for user interviews (1h)\nâ€¢ Record 3-min demo video (2h)\n\n**Wednesday â€” Investor Prep**\nâ€¢ Draft deck structure (2h)\nâ€¢ Write narrative slides (3h)\nâ€¢ Design pass on key visuals (2h)\n\n**Thursday â€” Interviews + Deck**\nâ€¢ User interviews Ã— 2 (2h)\nâ€¢ Refine deck based on feedback (3h)\nâ€¢ Practice pitch 3x (1.5h)\n\n**Friday â€” Ship + Outreach**\nâ€¢ Deploy MVP to pilot users (2h)\nâ€¢ User interviews Ã— 3 (3h)\nâ€¢ Send investor deck to 5 warm intros (1h)\n\nWant me to create calendar blocks for these?",
        time: "2 days ago"
      }
    ]
  }
];

let activeThread = null;
let renderedMsgCount = 0; // track already-rendered messages to skip their animation

// â”€â”€â”€ Smooth scroll via rAF â”€â”€â”€
function smoothScrollToBottom(container, duration) {
  duration = duration || 300;
  const start = container.scrollTop;
  const target = container.scrollHeight - container.clientHeight;
  const distance = target - start;
  if (distance <= 0) return;
  const startTime = performance.now();
  function step(now) {
    const elapsed = now - startTime;
    const t = Math.min(elapsed / duration, 1);
    // ease-out cubic
    const ease = 1 - Math.pow(1 - t, 3);
    container.scrollTop = start + distance * ease;
    if (t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// â”€â”€â”€ Render Functions â”€â”€â”€

function renderThreads(filter) {
  filter = filter || '';
  const el = document.getElementById('threadsList');
  const filtered = filter
    ? THREADS.filter(function(t) { return t.title.toLowerCase().includes(filter.toLowerCase()); })
    : THREADS;

  el.innerHTML = filtered.map(function(t) {
    var lastMsg = t.messages.length
      ? t.messages[t.messages.length - 1].text.replace(/\*\*/g, '').slice(0, 65)
      : 'Start a conversationâ€¦';
    return '<div class="thread-item ' + (t.unread ? 'thread-unread' : '') + '" onclick="openThread(' + t.id + ')">' +
        '<div class="thread-avatar ' + t.avatarColor + '">' + t.avatarLetter + '</div>' +
        '<div class="thread-body">' +
          '<div class="thread-top">' +
            '<div class="thread-title">' + t.title + '</div>' +
            '<div class="thread-time">' + t.time + '</div>' +
          '</div>' +
          '<div class="thread-preview">' + lastMsg + '</div>' +
        '</div>' +
        (t.unread ? '<div class="thread-badge"></div>' : '') +
      '</div>';
  }).join('');
}

function buildMsgHTML(m, idx, messages, options) {
  var isUser = m.role === 'user';
  var prevMsg = idx > 0 ? messages[idx - 1] : null;
  var nextMsg = idx < messages.length - 1 ? messages[idx + 1] : null;
  var showLabel = !isUser && (!prevMsg || prevMsg.role !== 'agent');
  var showAvatar = !isUser && (!prevMsg || prevMsg.role !== 'agent');
  var isNewSender = !prevMsg || prevMsg.role !== m.role;
  // Show timestamp on last message in a same-sender group, or very last msg
  var isLastInGroup = !nextMsg || nextMsg.role !== m.role;

  var staggerClass = '';
  if (options && options.stagger && idx >= (options.staggerFrom || 0)) {
    staggerClass = ' stagger-in';
  }

  var html = '<div class="msg ' + m.role + (isNewSender ? ' new-sender' : '') + staggerClass + '"';
  if (options && options.stagger && idx >= (options.staggerFrom || 0)) {
    var delay = (idx - (options.staggerFrom || 0)) * 50;
    html += ' style="animation-delay:' + delay + 'ms"';
  }
  html += '>';

  if (showAvatar) {
    html += '<div class="msg-avatar">A</div>';
  } else if (!isUser && !showAvatar) {
    html += '<div class="msg-avatar-spacer"></div>';
  }

  html += '<div class="msg-body">';
  if (showLabel) {
    html += '<div class="msg-label">Agentsy</div>';
  }
  html += '<div class="msg-bubble">' + formatText(m.text) + '</div>';

  // Attachments
  if (m.attachments) {
    m.attachments.forEach(function(a) {
      var previewId = 'preview_' + Math.random().toString(36).substr(2, 9);
      // Store preview data for later retrieval
      if (a.preview && a.preview.content) {
        _previewStore[previewId] = { title: a.name, content: a.preview.content };
      }
      if (a.linkPreview) {
        html += '<div class="link-preview" data-preview-id="' + previewId + '">' +
          '<div class="link-preview-img" style="background:' + a.linkPreview.img + '"></div>' +
          '<div class="link-preview-body">' +
            '<div class="link-preview-domain">' + a.linkPreview.domain + '</div>' +
            '<div class="link-preview-title">' + a.linkPreview.title + '</div>' +
            '<div class="link-preview-desc">' + a.linkPreview.desc + '</div>' +
          '</div>' +
        '</div>';
      } else {
        html += '<div class="attachment" data-preview-id="' + previewId + '">' +
          '<div class="attach-doc">' +
            '<div class="attach-icon ' + a.type + '">' + a.icon + '</div>' +
            '<div class="attach-info">' +
              '<div class="attach-name">' + a.name + '</div>' +
              '<div class="attach-meta">' + a.meta + '</div>' +
            '</div>' +
            '<div class="attach-action">Open â†’</div>' +
          '</div>' +
        '</div>';
      }
    });
  }

  // Table
  if (m.table) {
    html += '<div class="data-table"><table>' +
      '<thead><tr>' + m.table.headers.map(function(h) { return '<th>' + h + '</th>'; }).join('') + '</tr></thead>' +
      '<tbody>' + m.table.rows.map(function(r) { return '<tr>' + r.map(function(c) { return '<td>' + c + '</td>'; }).join('') + '</tr>'; }).join('') + '</tbody>' +
    '</table></div>';
  }

  html += '<div class="msg-time' + (isLastInGroup ? ' show' : '') + '">' + m.time + '</div>';
  html += '</div></div>';
  return html;
}

function renderMessages(stagger) {
  var thread = THREADS.find(function(t) { return t.id === activeThread; });
  if (!thread) return;

  document.getElementById('chatTitle').textContent = thread.title;
  var el = document.getElementById('messages');

  // Build all HTML at once (batch, no individual appends)
  var fragment = '';
  thread.messages.forEach(function(m, idx) {
    fragment += buildMsgHTML(m, idx, thread.messages, stagger ? { stagger: true, staggerFrom: 0 } : null);
  });
  el.innerHTML = fragment;
  renderedMsgCount = thread.messages.length;

  requestAnimationFrame(function() {
    el.scrollTop = el.scrollHeight;
  });
}

function formatText(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>')
    .replace(/> (.*?)(<br>|$)/g, '<div class="quote-block">$1</div>');
}

function esc(str) {
  return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
}

// â”€â”€â”€ Navigation â”€â”€â”€

function openThread(id) {
  activeThread = id;
  var t = THREADS.find(function(t) { return t.id === id; });
  if (t) t.unread = false;
  renderMessages(true); // stagger animation on open
  document.getElementById('views').classList.add('show-chat');
  setTimeout(function() { document.getElementById('input').focus(); }, 440);
}

function showThreads() {
  document.getElementById('views').classList.remove('show-chat');
  renderThreads();
}

function newThread() {
  activeThread = null;
  renderedMsgCount = 0;
  document.getElementById('chatTitle').textContent = 'New Thread';
  document.getElementById('messages').innerHTML =
    '<div class="empty-chat">' +
      '<div class="empty-icon">A</div>' +
      '<div class="empty-title">Start a conversation</div>' +
      '<div class="empty-subtitle">Research, writing, analysis, planning â€” just ask anything.</div>' +
    '</div>' +
    '<div class="suggestion-chips">' +
      '<button class="suggestion-chip" onclick="useSuggestion(this)">Research a topic</button>' +
      '<button class="suggestion-chip" onclick="useSuggestion(this)">Draft an email</button>' +
      '<button class="suggestion-chip" onclick="useSuggestion(this)">Analyze data</button>' +
    '</div>';
  document.getElementById('views').classList.add('show-chat');
  setTimeout(function() { document.getElementById('input').focus(); }, 440);
}

function useSuggestion(chip) {
  var input = document.getElementById('input');
  input.value = chip.textContent;
  input.focus();
  autoResize(input);
}

function filterThreads(q) { renderThreads(q); }

// â”€â”€â”€ Swipe-from-left-edge to go back â”€â”€â”€
(function() {
  var touchStartX = 0;
  var touchStartY = 0;
  var swiping = false;
  var edgeThreshold = 30; // px from left edge

  var chatView = document.getElementById('chatView');

  chatView.addEventListener('touchstart', function(e) {
    var touch = e.touches[0];
    if (touch.clientX < edgeThreshold && document.getElementById('views').classList.contains('show-chat')) {
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      swiping = true;
    }
  }, { passive: true });

  chatView.addEventListener('touchmove', function(e) {
    if (!swiping) return;
    // Just track â€” we trigger on end
  }, { passive: true });

  chatView.addEventListener('touchend', function(e) {
    if (!swiping) return;
    swiping = false;
    var touch = e.changedTouches[0];
    var dx = touch.clientX - touchStartX;
    var dy = Math.abs(touch.clientY - touchStartY);
    // Must be a horizontal swipe (dx > 60px, more horizontal than vertical)
    if (dx > 60 && dx > dy * 1.5) {
      showThreads();
    }
  }, { passive: true });
})();

// â”€â”€â”€ Streaming Text Simulation â”€â”€â”€

function streamText(bubbleEl, text, onDone) {
  var formatted = formatText(text);
  // We'll type out the raw text then set final formatted HTML
  var chars = text.split('');
  var i = 0;
  var speed = 18; // ms per character (smooth, readable pace)
  var cursor = '<span class="streaming-cursor">â”‚</span>';

  function tick() {
    if (i < chars.length) {
      var partial = text.slice(0, i + 1);
      bubbleEl.innerHTML = formatText(partial) + cursor;
      i++;
      // Vary speed slightly for natural feel
      var nextSpeed = speed + (Math.random() * 12 - 6);
      // Pause slightly longer after punctuation
      if ('.!?:'.includes(chars[i - 1])) nextSpeed += 60;
      else if (',;'.includes(chars[i - 1])) nextSpeed += 30;
      setTimeout(tick, nextSpeed);
    } else {
      // Done â€” remove cursor, set final HTML
      bubbleEl.innerHTML = formatted;
      if (onDone) onDone();
    }
  }
  tick();
}

// â”€â”€â”€ Messaging â”€â”€â”€

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMsg();
  }
}

function sendMsg() {
  var input = document.getElementById('input');
  var text = input.value.trim();
  if (!text) return;

  input.value = '';
  autoResize(input);

  // Pop animation on send button
  var sendBtn = document.getElementById('sendBtn');
  sendBtn.classList.remove('pop');
  void sendBtn.offsetWidth; // reflow to restart animation
  sendBtn.classList.add('pop');

  var el = document.getElementById('messages');
  // Clear empty state + chips
  var empty = el.querySelector('.empty-chat');
  var chips = el.querySelector('.suggestion-chips');
  if (empty) empty.remove();
  if (chips) chips.remove();

  var now = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

  // Determine if new sender (previous was agent or no messages)
  var allMsgs = el.querySelectorAll('.msg');
  var lastMsg = allMsgs.length ? allMsgs[allMsgs.length - 1] : null;
  var isNewSender = !lastMsg || lastMsg.classList.contains('agent');

  // Hide previous timestamp if it's showing
  if (lastMsg) {
    var prevTime = lastMsg.querySelector('.msg-time.show');
    if (prevTime && lastMsg.classList.contains('user')) {
      // Keep showing â€” different sender group now
    }
  }

  // User message â€” use innerHTML batch
  var userMsgHTML =
    '<div class="msg user stagger-in' + (isNewSender ? ' new-sender' : '') + '">' +
      '<div class="msg-body">' +
        '<div class="msg-bubble">' + formatText(text) + '</div>' +
        '<div class="msg-time show">' + now + '</div>' +
      '</div>' +
    '</div>';

  el.insertAdjacentHTML('beforeend', userMsgHTML);
  smoothScrollToBottom(el, 250);

  // Typing indicator
  var typingHTML =
    '<div class="msg agent new-sender stagger-in" id="typing">' +
      '<div class="msg-avatar">A</div>' +
      '<div class="msg-body">' +
        '<div class="msg-bubble" style="border:none;padding:0;background:transparent">' +
          '<div class="typing"><span></span><span></span><span></span></div>' +
        '</div>' +
      '</div>' +
    '</div>';

  setTimeout(function() {
    el.insertAdjacentHTML('beforeend', typingHTML);
    smoothScrollToBottom(el, 200);
  }, 400);

  // Simulated streaming response
  var responseText = "I'm on it â€” let me dig into that for you. Give me a moment to pull together the research.";

  setTimeout(function() {
    var typing = document.getElementById('typing');
    if (typing) typing.remove();

    var responseHTML =
      '<div class="msg agent new-sender stagger-in">' +
        '<div class="msg-avatar">A</div>' +
        '<div class="msg-body">' +
          '<div class="msg-label">Agentsy</div>' +
          '<div class="msg-bubble" id="streamBubble"></div>' +
          '<div class="msg-time show">' + now + '</div>' +
        '</div>' +
      '</div>';

    el.insertAdjacentHTML('beforeend', responseHTML);
    smoothScrollToBottom(el, 200);

    var bubble = document.getElementById('streamBubble');
    streamText(bubble, responseText, function() {
      bubble.removeAttribute('id'); // clean up
      smoothScrollToBottom(el, 150);
    });

    // Keep scrolling during streaming
    var scrollInterval = setInterval(function() {
      if (!document.getElementById('streamBubble')) {
        clearInterval(scrollInterval);
        return;
      }
      el.scrollTop = el.scrollHeight;
    }, 100);
  }, 1800);
}

// Auto-resize textarea â€” instant, no visible layout shift
var inputEl = document.getElementById('input');
function autoResize(el) {
  el.style.height = '0';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}
inputEl.addEventListener('input', function() { autoResize(this); });

// On composer focus, scroll messages to bottom (handles virtual keyboard)
inputEl.addEventListener('focus', function() {
  var el = document.getElementById('messages');
  setTimeout(function() {
    smoothScrollToBottom(el, 200);
  }, 300); // delay for virtual keyboard animation
});

// Handle visual viewport resize (mobile keyboard)
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', function() {
    var el = document.getElementById('messages');
    requestAnimationFrame(function() {
      el.scrollTop = el.scrollHeight;
    });
  });
}

// â”€â”€â”€ Preview â”€â”€â”€

function openPreviewById(previewId) {
  var data = _previewStore[previewId];
  if (!data) return;
  document.getElementById('previewTitle').textContent = data.title;
  document.getElementById('previewBody').innerHTML = data.content;
  var overlay = document.getElementById('previewOverlay');
  overlay.style.display = 'flex';
  void overlay.offsetWidth;
  overlay.classList.add('show');
}

function openPreview(title, content) {
  document.getElementById('previewTitle').textContent = title;
  document.getElementById('previewBody').innerHTML = content;
  var overlay = document.getElementById('previewOverlay');
  overlay.style.display = 'flex';
  void overlay.offsetWidth;
  overlay.classList.add('show');
}

function closePreview() {
  var overlay = document.getElementById('previewOverlay');
  overlay.classList.remove('show');
  setTimeout(function() { overlay.style.display = 'none'; }, 260);
}

// Event delegation for attachment/link-preview clicks
document.addEventListener('click', function(e) {
  var target = e.target.closest('[data-preview-id]');
  if (target) {
    openPreviewById(target.getAttribute('data-preview-id'));
  }
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closePreview();
});

// â”€â”€â”€ Init â”€â”€â”€
renderThreads();
</script>
</body>
</html>
